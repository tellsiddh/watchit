<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>WatchIt Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #fafafa; color: #222; text-align: center; padding: 40px; }
    h1 { margin-bottom: 10px; }
    .meta { font-size: 1em; margin-bottom: 20px; color: #555; }
    .stats { font-size: 1.5em; margin: 20px 0; }
    #chart-container { width: 95%; height: 500px; margin: auto; }
    button { padding: 8px 16px; font-size: 1em; cursor: pointer; margin-top: 10px; }
  </style>
</head>
<body>
  <h1>Wikimedia Activity</h1>

  <div class="meta">
    <div id="startTime">Start time: …</div>
    <div id="currentTime">Now: …</div>
  </div>

  <div class="stats">
    <div id="edits">Edits: …</div>
    <div id="pages">Pages: …</div>
  </div>
  <button onclick="resetStart()">Reset Counter</button>

  <div id="chart-container">
    <canvas id="activityChart"></canvas>
  </div>

  <script>
    const API_STATS = "/stats";
    const API_HISTORY = "/history?limit=50";

    let chart = new Chart(document.getElementById('activityChart').getContext('2d'), {
      type: 'line',
      data: {
        labels: [],
        datasets: [
          { label: 'Edits per 10s', data: [], borderColor: 'blue', yAxisID: 'yEdits', fill: false },
          { label: 'Pages per 10s', data: [], borderColor: 'green', yAxisID: 'yPages', fill: false }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          yEdits: { type: 'linear', position: 'left', beginAtZero: true },
          yPages: { type: 'linear', position: 'right', beginAtZero: true, grid: { drawOnChartArea: false } }
        }
      }
    });

    function getStartTime() {
      let start = localStorage.getItem("watchit_start");
      if (!start) {
        start = Date.now();
        localStorage.setItem("watchit_start", start);
      }
      return parseInt(start, 10);
    }

    function formatTime(ms) { return new Date(ms).toLocaleString(); }

    function resetStart() {
      const now = Date.now();
      localStorage.setItem("watchit_start", now);
      document.getElementById("startTime").innerText = "Start time: " + formatTime(now);
      chart.data.labels = [];
      chart.data.datasets[0].data = [];
      chart.data.datasets[1].data = [];
      chart.update();
      updateStats();
    }

    async function updateStats() {
      const start = getStartTime();
      document.getElementById("startTime").innerText = "Start time: " + formatTime(start);
      document.getElementById("currentTime").innerText = "Now: " + formatTime(Date.now());

      try {
        // update totals
        const respStats = await fetch(`${API_STATS}?start=${start}`);
        const dataStats = await respStats.json();
        document.getElementById("edits").innerText = `Edits: ${dataStats.edits}`;
        document.getElementById("pages").innerText = `Pages: ${dataStats.pages}`;

        // update chart with deltas
        const respHist = await fetch(API_HISTORY);
        const dataHist = await respHist.json();
        chart.data.labels = dataHist.map(d => new Date(d.ts).toLocaleTimeString());
        chart.data.datasets[0].data = dataHist.map(d => d.edits);
        chart.data.datasets[1].data = dataHist.map(d => d.pages);
        chart.update();
      } catch (err) {
        console.error("Failed to fetch stats/history", err);
      }
    }

    updateStats();
    setInterval(updateStats, 10000);
  </script>
</body>
</html>
